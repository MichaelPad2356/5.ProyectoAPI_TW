<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juego de Arrastrar Personajes a Casas</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            font-family: 'Press Start 2P', cursive;
            background-color: #222;
            color: #fff;
        }

        #lienzoContainer {
            display: flex;
            margin-top: 20px;
        }

        .lienzo {
            border: 2px solid #fff;
            margin-right: 20px;
            position: relative;
            width: 430px;
            height: 430px;
            overflow: hidden;
        }

        .imagen-casa {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            visibility: hidden;
        }

        #cajasimagenes {
            margin-top: 20px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
        }

        #cajasimagenes div {
            display: flex;
            justify-content: center;
            align-items: center;
            background-size: 0;
            /* Establece el tamaño de fondo a 0 para ocultar la imagen */
        }

        #cajasimagenes div img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            max-width: 100%;
            max-height: 100%;
            cursor: pointer;
        }

        #mensajeJuego {
            margin-top: 20px;
            font-size: 24px;
            text-align: center;
            transition: opacity 0.5s ease-in-out;
        }

        #nombrePersonaje {
            margin-top: 10px;
            font-size: 20px;
        }

        #puntaje {
            margin-top: 10px;
            font-size: 20px;
        }
    </style>
    <link href="https://fonts.googleapis.com/css?family=Press+Start+2P" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
</head>

<body>

    <!-- Lienzos para las casas -->
    <div id="lienzoContainer">
        <div id="lienzo1" class="lienzo"></div>
        <div id="lienzo2" class="lienzo"></div>
        <div id="lienzo3" class="lienzo"></div>
    </div>

    <!-- Sección para las imágenes de los personajes -->
    <section id="cajasimagenes">
        <!-- Aquí se agregarán dinámicamente las imágenes de los personajes -->
    </section>

    <!-- Mensaje del juego -->
    <div id="mensajeJuego"></div>

    <!-- Nombre del personaje -->
    <div id="nombrePersonaje"></div>

    <!-- Puntaje -->
    <div id="puntaje">Puntaje: 0</div>

    <script>
        const mapeoCasasPersonajes = {
            '../media/Casas/Cuphead9.png': {
                personaje: '../media/Personajes/Cuphead.png',
                sonido: '../media/audios/sonido_personajes/Cuphead.wav',
                voz: '../media/audios/voz_personajes/cuphead.wav',
                nombre: 'Cuphead'
            },
            '../media/Casas/Donkey4.png': {
                personaje: '../media/Personajes/DonkeyKong.png',
                sonido: '../media/audios/sonido_personajes/Donkeykong.wav',
                voz: '../media/audios/voz_personajes/donkeykong.wav',
                nombre: 'Donkey Kong'
            },
            '../media/Casas/KirbyDL2.png': {
                personaje: '../media/Personajes/Kirby.png',
                sonido: '../media/audios/sonido_personajes/Kirby.wav',
                voz: '../media/audios/voz_personajes/kirby.wav',
                nombre: 'Kirby'
            },
            '../media/Casas/MarioB1.png': {
                personaje: '../media/Personajes/MarioBros.png',
                sonido: '../media/audios/sonido_personajes/Mario.wav',
                voz: '../media/audios/voz_personajes/mariobros.wav',
                nombre: 'Mario Bros'
            },
            '../media/Casas/Minecraft6.png': {
                personaje: '../media/Personajes/Minecraft.png',
                sonido: '../media/audios/sonido_personajes/Minecraft.wav',
                voz: '../media/audios/voz_personajes/minecraft.wav',
                nombre: 'Minecraft'
            },
            '../media/Casas/Packman7.png': {
                personaje: '../media/Personajes/Pacman.png',
                sonido: '../media/audios/sonido_personajes/Pacman.wav',
                voz: '../media/audios/voz_personajes/pacman.wav',
                nombre: 'Pacman'
            },
            '../media/Casas/Pokemon8.png': {
                personaje: '../media/Personajes/Pokemon.png',
                sonido: '../media/audios/sonido_personajes/Pokemon.wav',
                voz: '../media/audios/voz_personajes/pokemon.wav',
                nombre: 'Pokemon'
            },
            '../media/Casas/Sonic3.png': {
                personaje: '../media/Personajes/Sonic.png',
                sonido: '../media/audios/sonido_personajes/Sonic.wav',
                voz: '../media/audios/voz_personajes/sonic.wav',
                nombre: 'Sonic'
            },
            '../media/Casas/Zelda5.png': {
                personaje: '../media/Personajes/Zelda.png',
                sonido: '../media/audios/sonido_personajes/Zelda.wav',
                voz: '../media/audios/voz_personajes/zelda.wav',
                nombre: 'Zelda'
            }
        };

        let imagenesSeleccionadas = [];
        let mensajeTimeout;
        let puntaje = 0;

        function iniciar() {
            // Eliminar los elementos guardados en localStorage
            localStorage.removeItem('elementosPantalla1');
            localStorage.removeItem('puntaje');

            puntaje = 0;
            actualizarPuntaje();

            // Seleccionar nuevas imágenes de casas aleatorias
            imagenesSeleccionadas = seleccionarImagenesAleatorias(Object.keys(mapeoCasasPersonajes), 3);
            localStorage.setItem('elementosPantalla1', JSON.stringify(imagenesSeleccionadas));

            const imagenes = document.querySelectorAll('#cajasimagenes > div');
            for (var i = 0; i < imagenes.length; i++) {
                imagenes[i].addEventListener('dragstart', arrastrar, false);
                imagenes[i].addEventListener('dragend', finalizado, false);
                imagenes[i].style.position = 'absolute';
                imagenes[i].style.left = '-1000px';
                imagenes[i].style.top = '-1000px';
            }

            const lienzos = document.querySelectorAll('.lienzo');
            for (var i = 0; i < lienzos.length; i++) {
                lienzos[i].addEventListener('dragenter', eventoEnter, false);
                lienzos[i].addEventListener('dragover', eventoSobre, false);
                lienzos[i].addEventListener('drop', eventoDrop, false);
            }

            for (var i = 0; i < lienzos.length; i++) {
                const lienzo = lienzos[i];
                const imagenCasa = imagenesSeleccionadas[i];

                lienzo.style.backgroundImage = 'url(' + imagenCasa + ')';
                lienzo.style.backgroundSize = '100% 100%';
                lienzo.style.backgroundRepeat = 'no-repeat';
                lienzo.style.backgroundPosition = 'center';
            }

            const imagenesPersonajesFiltradas = Object.values(mapeoCasasPersonajes).filter(personaje => imagenesSeleccionadas.includes(Object.keys(mapeoCasasPersonajes).find(casa => mapeoCasasPersonajes[casa].personaje === personaje.personaje)));

            document.getElementById('cajasimagenes').innerHTML = '';

            for (var i = 0; i < imagenesPersonajesFiltradas.length; i++) {
                const divPersonaje = document.createElement('div');
                divPersonaje.style.width = '190px';
                divPersonaje.style.height = '190px';
                divPersonaje.style.marginRight = '60px';
                divPersonaje.style.marginTop = '60px';
                divPersonaje.style.backgroundImage = 'url(' + imagenesPersonajesFiltradas[i].personaje + ')';
                divPersonaje.id = 'div' + i;
                divPersonaje.draggable = true;
                divPersonaje.addEventListener('dragstart', arrastrar, false);
                divPersonaje.addEventListener('dragend', finalizado, false);

                const imgPersonaje = document.createElement('img');
                imgPersonaje.src = imagenesPersonajesFiltradas[i].personaje;
                imgPersonaje.draggable = false;
                divPersonaje.appendChild(imgPersonaje);

                document.getElementById('cajasimagenes').appendChild(divPersonaje);
            }
        }

        function finalizado(e) {
            var elemento = e.target;
            // No es necesario ocultar la imagen en esta función
        }

        function arrastrar(e) {
            var elemento = e.target;
            e.dataTransfer.setData('Text', elemento.getAttribute('id'));
            e.dataTransfer.setDragImage(elemento, elemento.clientWidth / 2, elemento.clientHeight / 2);
        }

        function eventoEnter(e) {
            e.preventDefault();
        }

        function eventoSobre(e) {
            e.preventDefault();
        }

        function eventoDrop(e) {
        e.preventDefault();
        var id = e.dataTransfer.getData('Text');
        var divPersonaje = document.getElementById(id);
        var lienzo = e.target;

        if (lienzo.classList.contains('lienzo')) {
            var imagenCasaActual = lienzo.style.backgroundImage.replace('url("', '').replace('")', '');
            var imagenPersonajeActual = divPersonaje.style.backgroundImage.replace('url("', '').replace('")', '');

            // Verificar si el lienzo ya tiene una imagen
            if (lienzo.querySelector('.imagen-personaje')) {
                mostrarMensaje("Ya no puedes colocar aquí", "rojo");

                // Restar puntaje por intento fallido
                puntaje = Math.max(0, puntaje - 50); // Cambia el valor según tu preferencia
                actualizarPuntaje();

                return;
            }

            // Verificar si la imagen del personaje coincide con la casa correspondiente
            if (mapeoCasasPersonajes[imagenCasaActual].personaje === imagenPersonajeActual) {
                var imgPersonaje = divPersonaje.querySelector('img');

                // Crear un nuevo elemento img con la misma fuente
                var imgNueva = document.createElement('img');
                imgNueva.src = imgPersonaje.src;
                imgNueva.classList.add('imagen-personaje');

                // Posicionar y ajustar el tamaño de la imagen
                imgNueva.style.position = 'absolute';
                imgNueva.style.top = '50%';
                imgNueva.style.left = '50%';
                imgNueva.style.transform = 'translate(-50%, -50%)';
                imgNueva.style.maxWidth = '40%';
                imgNueva.style.maxHeight = '40%';

                lienzo.appendChild(imgNueva);

                // Agregar un elemento para mostrar el nombre debajo de la imagen en el lienzo
                const nombrePersonajeEnLienzo = document.createElement('div');
                nombrePersonajeEnLienzo.textContent = mapeoCasasPersonajes[imagenCasaActual].nombre;
                nombrePersonajeEnLienzo.style.textAlign = 'center';
                nombrePersonajeEnLienzo.style.fontSize = '12px';
                nombrePersonajeEnLienzo.style.color = '#fff';
                lienzo.appendChild(nombrePersonajeEnLienzo);

                // Ocultar el div que contiene la imagen arrastrada
                divPersonaje.style.visibility = 'hidden';

                // Reproducir sonido del personaje y luego la voz
                reproducirSonidoYVoz(mapeoCasasPersonajes[imagenCasaActual].sonido, mapeoCasasPersonajes[imagenCasaActual].voz);

                mostrarMensaje("¡Felicidades! ¡Acertaste!", "verde");

                // Actualizar puntaje por imagen correcta
                puntaje += 135;
                actualizarPuntaje();

                // Verificar si todas las imágenes están colocadas correctamente
                var imagenesEnLienzos = document.querySelectorAll('.lienzo .imagen-personaje');
                if (imagenesEnLienzos.length === 3) {
                    // Todas las imágenes están colocadas correctamente, realizar la redirección con efecto de animación
                    setTimeout(function () {
                        anime({
                            targets: 'body',
                            opacity: 0,
                            duration: 1000, // Duración de la animación (en milisegundos)
                            easing: 'easeInOutQuad', // Tipo de animación
                            complete: function () {
                                // Guardar el puntaje en localStorage antes de redirigir
                                localStorage.setItem('puntaje', puntaje);
                                window.location.href = "prueba2.html";
                            }
                        });
                    }, 6000);
                }
            } else {
                // Restar puntaje por error
                puntaje = Math.max(0, puntaje - 65);
                actualizarPuntaje();

                mostrarMensaje("Inténtalo de nuevo", "rojo");
            }
        }
    }

        function reproducirSonidoYVoz(nombreSonido, nombreVoz) {
            reproducirSonido(nombreSonido)
                .then(() => reproducirVoz(nombreVoz))
                .catch((error) => console.error(error));
        }

        function reproducirSonido(nombreSonido) {
            return new Promise((resolve, reject) => {
                const audio = new Audio(nombreSonido);
                audio.addEventListener('ended', () => resolve());
                audio.addEventListener('error', (error) => reject(error));
                audio.play();
            });
        }

        function reproducirVoz(nombreVoz) {
            return new Promise((resolve, reject) => {
                const voz = new Audio(nombreVoz);
                voz.addEventListener('ended', () => resolve());
                voz.addEventListener('error', (error) => reject(error));
                voz.play();
            });
        }

        function mostrarNombrePersonaje(nombre) {
            const nombrePersonaje = document.getElementById("nombrePersonaje");
            nombrePersonaje.textContent = 'Personaje: ' + nombre;
        }

        function seleccionarImagenesAleatorias(imagenes, cantidad) {
            const imagenesAleatorias = [];
            const copiaImagenes = [...imagenes];

            for (let i = 0; i < cantidad; i++) {
                const indiceAleatorio = Math.floor(Math.random() * copiaImagenes.length);
                const imagenSeleccionada = copiaImagenes.splice(indiceAleatorio, 1)[0];
                imagenesAleatorias.push(imagenSeleccionada);
            }

            return imagenesAleatorias;
        }

        function mostrarMensaje(mensaje, color) {
            const mensajeJuego = document.getElementById("mensajeJuego");
            mensajeJuego.textContent = mensaje;
            mensajeJuego.style.color = color;
            mensajeJuego.style.opacity = 1;

            clearTimeout(mensajeTimeout);
            mensajeTimeout = setTimeout(function () {
                mensajeJuego.style.opacity = 0;
            }, 2000);
        }

        function actualizarPuntaje() {
            document.getElementById('puntaje').textContent = 'Puntaje: ' + puntaje;
        }
        window.addEventListener('load', iniciar, false);
    </script>
</body>

</html>
